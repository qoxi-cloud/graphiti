# Graphiti gRPC Server - Combined (All-in-One) Image
#
# This runs FalkorDB embedded in the same container as the gRPC server.
# For separate database services, use:
#   - docker-compose-falkordb.yml (FalkorDB as separate service)
#   - docker-compose-neo4j.yml (Neo4j as separate service)

services:
  graphiti-grpc:
    image: zepai/graphiti-grpc:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        GRAPHITI_CORE_VERSION: ${GRAPHITI_CORE_VERSION:-0.23.0}
        GRPC_SERVER_VERSION: ${GRPC_SERVER_VERSION:-1.0.0}
        BUILD_DATE: ${BUILD_DATE:-}
        VCS_REF: ${VCS_REF:-}
    env_file:
      - path: ../.env
        required: false
    environment:
      # FalkorDB configuration
      - FALKORDB_PASSWORD=${FALKORDB_PASSWORD:-}
      - BROWSER=${BROWSER:-1}
      # gRPC Server configuration
      - FALKORDB_URI=redis://localhost:6379
      - FALKORDB_DATABASE=${FALKORDB_DATABASE:-default_db}
      - GRAPHITI_GROUP_ID=${GRAPHITI_GROUP_ID:-main}
      - SEMAPHORE_LIMIT=${SEMAPHORE_LIMIT:-10}
      - CONFIG_PATH=/app/config/config.yaml
    volumes:
      - falkordb_data:/var/lib/falkordb/data
      - grpc_logs:/var/log/graphiti
    ports:
      - "6379:6379"   # FalkorDB/Redis
      - "3000:3000"   # FalkorDB web UI
      - "50051:50051" # gRPC server
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "6379", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

volumes:
  falkordb_data:
    driver: local
  grpc_logs:
    driver: local
